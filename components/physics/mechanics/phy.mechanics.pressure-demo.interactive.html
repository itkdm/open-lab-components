<!-- @cmp-manifest
{
  "schema": "cmp-manifest/v1",
  "id": "phy.mechanics.pressure-demo.interactive",
  "name": "压强演示器（交互式）",
  "nameEn": "Pressure Demo (Interactive)",
  "category": "physics/mechanics",
  "version": "1.0.0",
  "viewport": { "w": 200, "h": 200 },
  "tags": ["pressure", "force", "area", "mechanics", "interactive", "sponge", "brick"],
  "props": [
    { "key": "size",        "type": "number(px)", "default": 200, "min": 120, "max": 400, "desc": "组件尺寸（正方形）" },
    { "key": "mass",        "type": "number",     "default": 2,   "min": 0.5, "max": 10,  "desc": "砖块质量(kg)" },
    { "key": "brickColor",  "type": "color",      "default": "#c62828", "desc": "砖块颜色" },
    { "key": "spongeColor", "type": "color",      "default": "#fff176", "desc": "海绵颜色" },
    { "key": "stroke",      "type": "color",      "default": "#333333", "desc": "描边颜色" },
    { "key": "strokeWidth", "type": "number",     "default": 1.2, "min": 0.5, "max": 3, "desc": "描边粗细" },
    { "key": "accent",      "type": "color",      "default": "#1565c0", "desc": "强调色（文字）" },
    { "key": "glow",        "type": "number(0-1)", "default": 0, "min": 0, "max": 1, "desc": "发光强度" }
  ],
  "cssVars": {
    "size":        "--cmp-size",
    "brickColor":  "--cmp-brick",
    "spongeColor": "--cmp-sponge",
    "stroke":      "--cmp-stroke",
    "strokeWidth": "--cmp-stroke-width",
    "accent":      "--cmp-accent",
    "glow":        "--cmp-glow"
  },
  "events": [
    {
      "name": "cmp:change",
      "type": "toggle",
      "values": {
        "orientation": "string — 当前朝向(flat/side/upright)",
        "area": "number(cm2) — 接触面积",
        "pressure": "number(Pa) — 压强"
      }
    }
  ]
}
-->
<div class="cmp" data-cmp-id="phy.mechanics.pressure-demo.interactive" role="img" aria-label="压强演示器（交互式）">
  <style>
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] {
      --s: var(--cmp-size, 200px);
      display: inline-block;
      width: var(--s);
      height: var(--s);
      filter: drop-shadow(0 0 calc(6px * var(--cmp-glow, 0))
              rgba(255,214,102, calc(0.8 * var(--cmp-glow, 0))));
      user-select: none;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] svg {
      width: 100%; height: 100%; display: block; overflow: visible;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__brick {
      cursor: pointer;
      transition: none;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__brick:hover {
      filter: brightness(1.1);
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__info {
      font-family: 'Courier New', Courier, monospace;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__label {
      font-family: Arial, 'Microsoft YaHei', sans-serif;
      font-weight: 600;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__btn {
      cursor: pointer;
    }
    .cmp[data-cmp-id="phy.mechanics.pressure-demo.interactive"] .pd__btn:hover .pd__btn-bg {
      fill-opacity: 0.15;
    }
  </style>

  <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <linearGradient id="pd__sponge-g" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="var(--cmp-sponge, #fff176)"/>
        <stop offset="1" stop-color="#f9a825"/>
      </linearGradient>
      <linearGradient id="pd__brick-g" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="var(--cmp-brick, #c62828)" stop-opacity="0.8"/>
        <stop offset="0.5" stop-color="var(--cmp-brick, #c62828)"/>
        <stop offset="1" stop-color="#7f0000"/>
      </linearGradient>
    </defs>

    <!-- 地面线 -->
    <line x1="20" y1="185" x2="180" y2="185"
          stroke="var(--cmp-stroke, #333)" stroke-width="0.8" stroke-dasharray="4,2" opacity="0.4"/>

    <!-- 海绵 -->
    <rect class="pd__sponge" rx="3"
          fill="url(#pd__sponge-g)"
          stroke="var(--cmp-stroke, #333)" stroke-width="var(--cmp-stroke-width, 1.2)"/>

    <!-- 海绵纹理（小孔） -->
    <g class="pd__sponge-dots" opacity="0.2">
    </g>

    <!-- 砖块（可点击切换） -->
    <g class="pd__brick">
      <rect class="pd__brick-rect" rx="2"
            fill="url(#pd__brick-g)"
            stroke="var(--cmp-stroke, #333)" stroke-width="var(--cmp-stroke-width, 1.2)"/>
      <!-- 砖块纹理线 -->
      <g class="pd__brick-lines" stroke="rgba(0,0,0,0.15)" stroke-width="0.5">
      </g>
    </g>

    <!-- 接触面积标注线 -->
    <g class="pd__area-mark" opacity="0.6">
      <line class="pd__area-l" stroke="var(--cmp-accent, #1565c0)" stroke-width="1"/>
      <line class="pd__area-r" stroke="var(--cmp-accent, #1565c0)" stroke-width="1"/>
      <line class="pd__area-m" stroke="var(--cmp-accent, #1565c0)" stroke-width="1" marker-start="url(#pd__arr)" marker-end="url(#pd__arr)"/>
    </g>

    <!-- 方向按钮组 -->
    <g class="pd__btns">
      <g class="pd__btn pd__btn-flat" transform="translate(30, 10)">
        <rect class="pd__btn-bg" x="-14" y="-8" width="28" height="16" rx="3"
              fill="var(--cmp-accent, #1565c0)" fill-opacity="0.08"
              stroke="var(--cmp-accent, #1565c0)" stroke-width="0.8"/>
        <text class="pd__label" text-anchor="middle" y="4" font-size="9"
              fill="var(--cmp-accent, #1565c0)">平放</text>
      </g>
      <g class="pd__btn pd__btn-side" transform="translate(100, 10)">
        <rect class="pd__btn-bg" x="-14" y="-8" width="28" height="16" rx="3"
              fill="var(--cmp-accent, #1565c0)" fill-opacity="0.08"
              stroke="var(--cmp-accent, #1565c0)" stroke-width="0.8"/>
        <text class="pd__label" text-anchor="middle" y="4" font-size="9"
              fill="var(--cmp-accent, #1565c0)">侧放</text>
      </g>
      <g class="pd__btn pd__btn-upright" transform="translate(170, 10)">
        <rect class="pd__btn-bg" x="-14" y="-8" width="28" height="16" rx="3"
              fill="var(--cmp-accent, #1565c0)" fill-opacity="0.08"
              stroke="var(--cmp-accent, #1565c0)" stroke-width="0.8"/>
        <text class="pd__label" text-anchor="middle" y="4" font-size="9"
              fill="var(--cmp-accent, #1565c0)">竖放</text>
      </g>
    </g>

    <!-- 数据文字 -->
    <text class="pd__info pd__orient-text" x="100" y="196" text-anchor="middle"
          font-size="9" fill="var(--cmp-accent, #1565c0)"></text>
    <text class="pd__info pd__area-text" x="100" y="38" text-anchor="middle"
          font-size="8.5" fill="var(--cmp-accent, #1565c0)"></text>
    <text class="pd__info pd__pressure-text" x="100" y="48" text-anchor="middle"
          font-size="8.5" fill="var(--cmp-accent, #1565c0)"></text>
  </svg>
</div>

<script>
(function() {
  var script = document.currentScript;
  if (!script) return;
  var root = script.previousElementSibling;
  if (!root || root.getAttribute('data-cmp-id') !== 'phy.mechanics.pressure-demo.interactive') return;

  var svg = root.querySelector('svg');
  if (!svg) return;

  /* ── 参数 ── */
  var P = {};
  try {
    var raw = root.getAttribute('data-props');
    if (raw) { var o = JSON.parse(raw); if (o && typeof o === 'object') P = o; }
  } catch(e) {}

  var mass = Math.max(0.5, Math.min(10, Number(P.mass) || 2));
  var g = 9.8;
  var F = mass * g; /* 重力 N */

  /* 砖块真实尺寸 cm: 24 x 12 x 6 */
  var BRICK_L = 24; /* 长 cm */
  var BRICK_W = 12; /* 宽 cm */
  var BRICK_H = 6;  /* 高 cm */

  /* 三种朝向: flat(平放), side(侧放), upright(竖放)
     平放: 底面 24x12, 高6   → A = 288 cm²
     侧放: 底面 24x6,  高12  → A = 144 cm²
     竖放: 底面 12x6,  高24  → A = 72 cm²  */
  var orientations = [
    { key: 'flat',    name: '平放', bw: 24, bh: 6,  area: 24 * 12 },
    { key: 'side',    name: '侧放', bw: 24, bh: 12, area: 24 * 6  },
    { key: 'upright', name: '竖放', bw: 12, bh: 24, area: 12 * 6  }
  ];
  var idx = 0;

  /* viewBox 坐标系中的缩放: 1cm ≈ 3px in viewBox */
  var SCALE = 3;
  var CX = 100;
  var GROUND_Y = 185;
  var SPONGE_FULL_H = 30; /* 海绵未压缩高度 */
  var SPONGE_W = 90;      /* 海绵宽度 */

  /* 最大压强用于归一化海绵压缩 */
  var maxPressure = (10 * g) / (72 * 1e-4); /* 最大质量 + 最小面积 */

  /* ── DOM ── */
  var sponge = root.querySelector('.pd__sponge');
  var spongeDots = root.querySelector('.pd__sponge-dots');
  var brickRect = root.querySelector('.pd__brick-rect');
  var brickLines = root.querySelector('.pd__brick-lines');
  var brickG = root.querySelector('.pd__brick');
  var orientText = root.querySelector('.pd__orient-text');
  var areaText = root.querySelector('.pd__area-text');
  var pressureText = root.querySelector('.pd__pressure-text');
  var btnFlat = root.querySelector('.pd__btn-flat');
  var btnSide = root.querySelector('.pd__btn-side');
  var btnUpright = root.querySelector('.pd__btn-upright');

  function updateBtnHighlight() {
    var btns = [btnFlat, btnSide, btnUpright];
    for (var i = 0; i < btns.length; i++) {
      if (!btns[i]) continue;
      var bg = btns[i].querySelector('.pd__btn-bg');
      if (bg) {
        bg.setAttribute('fill-opacity', i === idx ? '0.25' : '0.08');
        bg.setAttribute('stroke-width', i === idx ? '1.5' : '0.8');
      }
    }
  }

  function render() {
    var ori = orientations[idx];
    var areaCm2 = ori.area;
    var areaM2 = areaCm2 * 1e-4;
    var pressure = F / areaM2;

    /* 海绵压缩量: 按压强比例 */
    var compress = Math.min(0.7, (pressure / maxPressure) * 0.7);
    var spongeH = SPONGE_FULL_H * (1 - compress);
    var spongeY = GROUND_Y - spongeH;

    /* 海绵 */
    if (sponge) {
      sponge.setAttribute('x', CX - SPONGE_W / 2);
      sponge.setAttribute('y', spongeY);
      sponge.setAttribute('width', SPONGE_W);
      sponge.setAttribute('height', spongeH);
    }

    /* 海绵纹理点 */
    if (spongeDots) {
      spongeDots.innerHTML = '';
      var dotRows = Math.max(1, Math.floor(spongeH / 6));
      var dotCols = 8;
      for (var r = 0; r < dotRows; r++) {
        for (var c = 0; c < dotCols; c++) {
          var cx = (CX - SPONGE_W / 2 + 6) + c * (SPONGE_W - 12) / (dotCols - 1);
          var cy = spongeY + 3 + r * (spongeH - 6) / Math.max(1, dotRows - 1);
          var dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          dot.setAttribute('cx', cx.toFixed(1));
          dot.setAttribute('cy', cy.toFixed(1));
          dot.setAttribute('r', (1.2 * (1 - compress * 0.5)).toFixed(1));
          dot.setAttribute('fill', 'var(--cmp-stroke, #333)');
          spongeDots.appendChild(dot);
        }
      }
    }

    /* 砖块尺寸 (viewBox) */
    var bw = ori.bw * SCALE;
    var bh = ori.bh * SCALE;
    var bx = CX - bw / 2;
    var by = spongeY - bh;

    if (brickRect) {
      brickRect.setAttribute('x', bx.toFixed(1));
      brickRect.setAttribute('y', by.toFixed(1));
      brickRect.setAttribute('width', bw.toFixed(1));
      brickRect.setAttribute('height', bh.toFixed(1));
    }

    /* 砖块纹理线 */
    if (brickLines) {
      brickLines.innerHTML = '';
      /* 水平线 */
      var hLines = Math.max(0, Math.floor(bh / 10) - 1);
      for (var i = 1; i <= hLines; i++) {
        var ly = by + i * bh / (hLines + 1);
        var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', bx.toFixed(1));
        line.setAttribute('y1', ly.toFixed(1));
        line.setAttribute('x2', (bx + bw).toFixed(1));
        line.setAttribute('y2', ly.toFixed(1));
        line.setAttribute('stroke', 'rgba(0,0,0,0.15)');
        line.setAttribute('stroke-width', '0.5');
        brickLines.appendChild(line);
      }
    }

    /* 数据文字 */
    if (orientText) {
      orientText.textContent = ori.name + ' | A=' + areaCm2 + 'cm\u00B2 | P=' + Math.round(pressure) + 'Pa';
    }
    if (areaText) {
      areaText.textContent = 'F=' + F.toFixed(1) + 'N  A=' + areaCm2 + 'cm\u00B2=' + areaM2.toFixed(4) + 'm\u00B2';
    }
    if (pressureText) {
      pressureText.textContent = 'P=F/A=' + Math.round(pressure) + ' Pa';
    }

    updateBtnHighlight();

    root.setAttribute('aria-label',
      '\u538B\u5F3A\u6F14\u793A\u5668 ' + ori.name +
      ' A=' + areaCm2 + 'cm\u00B2 P=' + Math.round(pressure) + 'Pa');
  }

  render();

  /* ── 事件 ── */
  function getValues() {
    var ori = orientations[idx];
    var areaCm2 = ori.area;
    var areaM2 = areaCm2 * 1e-4;
    var pressure = F / areaM2;
    return {
      orientation: ori.key,
      area: areaCm2,
      pressure: Math.round(pressure * 100) / 100
    };
  }

  function emitChange() {
    root.dispatchEvent(new CustomEvent('cmp:change', {
      bubbles: true, composed: true,
      detail: { id: root.getAttribute('data-cmp-id'), type: 'toggle', values: getValues() }
    }));
  }

  /* ── 点击切换 ── */
  function setOrientation(newIdx) {
    if (newIdx === idx) return;
    idx = newIdx;
    render();
    emitChange();
  }

  /* 砖块点击循环 */
  if (brickG) {
    brickG.addEventListener('click', function() {
      setOrientation((idx + 1) % 3);
    });
  }

  /* 按钮点击 */
  if (btnFlat) btnFlat.addEventListener('click', function() { setOrientation(0); });
  if (btnSide) btnSide.addEventListener('click', function() { setOrientation(1); });
  if (btnUpright) btnUpright.addEventListener('click', function() { setOrientation(2); });
})();
</script>