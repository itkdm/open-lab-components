<!-- @cmp-manifest
{
  "schema": "cmp-manifest/v1",
  "id": "phy.optics.refraction.interactive",
  "name": "光的折射（交互式）",
  "nameEn": "Light Refraction (Interactive)",
  "category": "physics/optics",
  "version": "1.0.0",
  "viewport": { "w": 480, "h": 400 },
  "props": [
    { "key": "size",          "type": "number(px)", "default": 400, "min": 280, "max": 600, "desc": "组件高度" },
    { "key": "stroke",        "type": "color",  "default": "#333333", "desc": "描边颜色" },
    { "key": "strokeWidth",   "type": "number", "default": 1.5, "min": 0.5, "max": 4, "desc": "描边粗细" },

    { "key": "medium1Color",  "type": "color",  "default": "#e3f2fd", "desc": "介质1颜色（上方，空气）" },
    { "key": "medium2Color",  "type": "color",  "default": "#bbdefb", "desc": "介质2颜色（下方，水/玻璃）" },
    { "key": "interfaceColor","type": "color",  "default": "#90a4ae", "desc": "分界面颜色" },
    { "key": "normalColor",   "type": "color",  "default": "#4caf50", "desc": "法线颜色" },

    { "key": "incidentColor", "type": "color",  "default": "#ff9800", "desc": "入射光颜色" },
    { "key": "refractColor",  "type": "color",  "default": "#2196f3", "desc": "折射光颜色" },
    { "key": "reflectColor",  "type": "color",  "default": "#ffb74d", "desc": "反射光颜色" },
    { "key": "rayWidth",      "type": "number", "default": 2.2, "min": 0.5, "max": 5, "desc": "光线粗细" },

    { "key": "n1",            "type": "number", "default": 1.0,  "min": 1.0, "max": 2.5, "desc": "介质1折射率" },
    { "key": "n2",            "type": "number", "default": 1.5,  "min": 1.0, "max": 2.5, "desc": "介质2折射率" },
    { "key": "initAngle",     "type": "number", "default": 40,   "min": 0,   "max": 85,  "desc": "初始入射角（度）" },
    { "key": "medium1Name",   "type": "string", "default": "空气",  "desc": "介质1名称" },
    { "key": "medium2Name",   "type": "string", "default": "玻璃",  "desc": "介质2名称" },

    { "key": "showLabels",    "type": "enum",  "default": "on", "enum": ["on","off"], "desc": "角度标注" },
    { "key": "showReflect",   "type": "enum",  "default": "on", "enum": ["on","off"], "desc": "显示反射光" },
    { "key": "showData",      "type": "enum",  "default": "on", "enum": ["on","off"], "desc": "数据面板" },

    { "key": "accent",        "type": "color",  "default": "#1565c0", "desc": "强调色" },
    { "key": "glow",          "type": "number(0-1)", "default": 0, "min": 0, "max": 1, "desc": "亮度" }
  ],
  "cssVars": {
    "size": "--cmp-size", "stroke": "--cmp-stroke", "strokeWidth": "--cmp-stroke-width",
    "medium1Color": "--cmp-m1", "medium2Color": "--cmp-m2",
    "interfaceColor": "--cmp-interface", "normalColor": "--cmp-normal",
    "incidentColor": "--cmp-incident", "refractColor": "--cmp-refract",
    "reflectColor": "--cmp-reflect", "rayWidth": "--cmp-ray-width",
    "accent": "--cmp-accent", "glow": "--cmp-glow"
  },
  "tags": ["optics","refraction","snell-law","light","interactive","draggable"],
  "events": [
    { "name": "cmp:change", "type": "slide", "values": { "angle": "number(deg) — 入射角" } },
    { "name": "cmp:changeend", "type": "slide", "values": { "angle": "number(deg) — 入射角" } }
  ]
}
-->
<div class="cmp" data-cmp-id="phy.optics.refraction.interactive" role="img" aria-label="光的折射（交互式）">
    <style>
      .cmp[data-cmp-id="phy.optics.refraction.interactive"]{
        --h:var(--cmp-size,400px);display:inline-block;width:calc(var(--h)*1.2);height:var(--h);
        filter:drop-shadow(0 0 calc(8px*var(--cmp-glow,0)) rgba(255,214,102,calc(.8*var(--cmp-glow,0))));
        user-select:none;touch-action:none;
      }
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] svg{width:100%;height:100%;display:block;overflow:visible}
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] .rfr__drag{cursor:pointer}
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] .rfr__label{font-family:'Times New Roman',serif;font-style:italic;font-weight:700}
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] .rfr__data{font-family:'Courier New',monospace;font-weight:600;font-variant-numeric:tabular-nums}
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] .rfr__desc{font-family:Arial,'Microsoft YaHei',sans-serif;font-weight:600}
      .cmp[data-cmp-id="phy.optics.refraction.interactive"] .rfr__medium-label{font-family:Arial,'Microsoft YaHei',sans-serif;font-weight:600;font-size:13px}
    </style>
  
    <svg viewBox="0 0 480 400" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <marker id="rfr__ah-in" viewBox="0 0 8 6" refX="7" refY="3" markerWidth="7" markerHeight="5" orient="auto-start-reverse">
          <path d="M0,0 L8,3 L0,6 Z" fill="var(--cmp-incident,#ff9800)"/>
        </marker>
        <marker id="rfr__ah-rf" viewBox="0 0 8 6" refX="7" refY="3" markerWidth="7" markerHeight="5" orient="auto-start-reverse">
          <path d="M0,0 L8,3 L0,6 Z" fill="var(--cmp-refract,#2196f3)"/>
        </marker>
        <marker id="rfr__ah-rl" viewBox="0 0 8 6" refX="7" refY="3" markerWidth="7" markerHeight="5" orient="auto-start-reverse">
          <path d="M0,0 L8,3 L0,6 Z" fill="var(--cmp-reflect,#ffb74d)"/>
        </marker>
      </defs>
  
      <!-- ═══ 1. 两种介质背景 ═══ -->
      <rect x="0" y="0" width="480" height="200"
            fill="var(--cmp-m1,#e3f2fd)" opacity=".35"/>
      <rect x="0" y="200" width="480" height="200"
            fill="var(--cmp-m2,#bbdefb)" opacity=".45"/>
  
      <!-- ═══ 2. 分界面 ═══ -->
      <line x1="20" y1="200" x2="460" y2="200"
            stroke="var(--cmp-interface,#90a4ae)" stroke-width="2"/>
  
      <!-- 介质名称标签 -->
      <text class="rfr__medium-label rfr__m1lbl" x="440" y="25"
            fill="var(--cmp-accent,#1565c0)" text-anchor="end" opacity=".7"></text>
      <text class="rfr__medium-label rfr__m2lbl" x="440" y="390"
            fill="var(--cmp-accent,#1565c0)" text-anchor="end" opacity=".7"></text>
  
      <!-- ═══ 3. 法线（竖直虚线通过入射点） ═══ -->
      <line class="rfr__normal" stroke="var(--cmp-normal,#4caf50)" stroke-width="1"
            stroke-dasharray="4,3" opacity=".5"/>
      <text class="rfr__normal-lbl" font-size="10" fill="var(--cmp-normal,#4caf50)"
            opacity=".6" font-family="Arial,sans-serif"></text>
  
      <!-- ═══ 4. 入射光 ═══ -->
      <line class="rfr__ray-in" stroke="var(--cmp-incident,#ff9800)"
            stroke-width="var(--cmp-ray-width,2.2)" marker-end="url(#rfr__ah-in)"/>
  
      <!-- ═══ 5. 折射光 ═══ -->
      <line class="rfr__ray-rf" stroke="var(--cmp-refract,#2196f3)"
            stroke-width="var(--cmp-ray-width,2.2)" marker-end="url(#rfr__ah-rf)"/>
  
      <!-- ═══ 6. 反射光（可选） ═══ -->
      <line class="rfr__ray-rl" stroke="var(--cmp-reflect,#ffb74d)"
            stroke-width="calc(var(--cmp-ray-width,2.2) * 0.7)" stroke-dasharray="5,3"
            marker-end="url(#rfr__ah-rl)" opacity="0"/>
  
      <!-- ═══ 7. 全反射提示 ═══ -->
      <text class="rfr__total-ref rfr__desc" x="240" y="310" font-size="14"
            fill="var(--cmp-accent,#1565c0)" text-anchor="middle" opacity="0"></text>
  
      <!-- ═══ 8. 角度弧 ═══ -->
      <path class="rfr__arc1" fill="none" stroke="var(--cmp-incident,#ff9800)" stroke-width="1.3"/>
      <text class="rfr__arc1t rfr__label" font-size="12" fill="var(--cmp-incident,#ff9800)" text-anchor="end"></text>
      <path class="rfr__arc2" fill="none" stroke="var(--cmp-refract,#2196f3)" stroke-width="1.3"/>
      <text class="rfr__arc2t rfr__label" font-size="12" fill="var(--cmp-refract,#2196f3)" text-anchor="end"></text>
  
      <!-- ═══ 9. 拖拽点 ═══ -->
      <g class="rfr__drag">
        <circle class="rfr__dot1" r="8" fill="var(--cmp-incident,#ff9800)" opacity=".2"/>
        <circle class="rfr__dot2" r="4" fill="var(--cmp-incident,#ff9800)" opacity=".6"/>
        <rect class="rfr__hit" fill="transparent" cursor="pointer"/>
      </g>
  
      <!-- ═══ 10. 数据面板 ═══ -->
      <g class="rfr__panel">
        <rect x="8" y="6" rx="4" width="210" height="78"
              fill="rgba(255,255,255,.92)" stroke="var(--cmp-stroke,#333)" stroke-width=".8"/>
        <text class="rfr__data rfr__d1" x="16" y="23" font-size="11" fill="var(--cmp-stroke,#333)"></text>
        <text class="rfr__data rfr__d2" x="16" y="38" font-size="11" fill="var(--cmp-stroke,#333)"></text>
        <text class="rfr__data rfr__d3" x="16" y="53" font-size="11" fill="var(--cmp-stroke,#333)"></text>
        <text class="rfr__desc rfr__d4" x="16" y="72" font-size="10.5" fill="var(--cmp-accent,#1565c0)"></text>
      </g>
    </svg>
  
    <script>
    (function(){
      var sc=document.currentScript;if(!sc)return;
      var root=sc.parentElement;
      if(!root||root.getAttribute('data-cmp-id')!=='phy.optics.refraction.interactive')return;
      var svg=root.querySelector('svg');if(!svg)return;
  
      var P={};
      try{var r=root.getAttribute('data-props');if(r){var o=JSON.parse(r);if(o&&typeof o==='object')P=o;}}catch(e){}
  
      var n1=Math.max(1,Math.min(2.5,Number(P.n1)||1.0));
      var n2=Math.max(1,Math.min(2.5,Number(P.n2)||1.5));
      var angle=Math.max(0,Math.min(85,Number(P.initAngle)||40));
      var m1Name=String(P.medium1Name||'空气');
      var m2Name=String(P.medium2Name||'玻璃');
      var showLabels=(P.showLabels!=='off');
      var showReflect=(P.showReflect!=='off');
      var showData=(P.showData!=='off');
  
      var DEG=Math.PI/180;
      var VB_W=480, VB_H=400;
  
      /*
       * ===== 坐标系 =====
       *
       *  viewBox: 480×400
       *  分界面: y = IFY = 200（水平线）
       *  入射点 O = (240, 200)（正中）
       *
       *  法线: 竖直线（垂直于水平分界面），通过 O
       *
       *  上方: 介质1（空气 n1=1.0）
       *  下方: 介质2（玻璃 n2=1.5）
       *
       *  入射光从左上方射到 O:
       *    入射角 θ₁ 是入射光与法线（竖直）的夹角
       *    光源 = O + RLEN * (-sinθ₁, -cosθ₁)
       *    (θ₁=0 时垂直向下入射, θ₁=40° 时从左上偏斜)
       *    SVG中: 向上=y减小, 向左=x减小
       *    光源 = (240 - RLEN·sinθ₁, 200 - RLEN·cosθ₁) ← 左上方 ✓
       *
       *  折射光从 O 向下方射出:
       *    由斯涅尔定律: n1·sinθ₁ = n2·sinθ₂
       *    θ₂ = asin(n1·sinθ₁/n2)
       *    折射光终点 = O + RLEN * (sinθ₂, cosθ₂)
       *    = (240 + RLEN·sinθ₂, 200 + RLEN·cosθ₂) ← 右下方 ✓
       *
       *    当 n1 > n2 且 θ₁ > arcsin(n2/n1) 时：全反射
       *
       *  反射光从 O 向右上方:
       *    反射角 = θ₁
       *    终点 = (240 + RLEN·sinθ₁, 200 - RLEN·cosθ₁) ← 右上方 ✓
       */
  
      var OX=240, IFY=200;
      var RLEN=170;
  
      function q(c){return root.querySelector('.rfr__'+c)}
      var el={};
      ['normal','normal-lbl','ray-in','ray-rf','ray-rl','total-ref',
       'arc1','arc1t','arc2','arc2t',
       'dot1','dot2','hit','d1','d2','d3','d4','panel',
       'm1lbl','m2lbl'
      ].forEach(function(k){el[k]=q(k)});
  
      if(!showData&&el['panel'])el['panel'].setAttribute('opacity','0');
  
      /* 介质标签 */
      if(el['m1lbl'])el['m1lbl'].textContent=m1Name+' (n₁='+n1.toFixed(2)+')';
      if(el['m2lbl'])el['m2lbl'].textContent=m2Name+' (n₂='+n2.toFixed(2)+')';
  
      function setL(e,x1,y1,x2,y2){
        if(!e)return;
        e.setAttribute('x1',x1);e.setAttribute('y1',y1);
        e.setAttribute('x2',x2);e.setAttribute('y2',y2);
      }
  
      function render(){
        var th1=angle*DEG;
        var s1=Math.sin(th1), c1=Math.cos(th1);
  
        /* 法线（竖直，通过入射点 O） */
        setL(el['normal'], OX, IFY-140, OX, IFY+140);
        if(el['normal-lbl']){
          el['normal-lbl'].setAttribute('x', OX+6);
          el['normal-lbl'].setAttribute('y', IFY-145);
          el['normal-lbl'].textContent='法线';
        }
  
        /* 入射光: 左上方 → O */
        var srcX=OX-RLEN*s1, srcY=IFY-RLEN*c1;
        /* 箭头方向: 从光源到O，留间距 */
        var inLen=RLEN, ux=s1, uy=c1; /* 归一化方向（从光源到O）: (+sin, +cos) */
        setL(el['ray-in'], srcX, srcY, OX-7*ux, IFY-7*uy);
  
        /* 斯涅尔定律: n1·sinθ₁ = n2·sinθ₂ */
        var sinTh2=n1*s1/n2;
        var totalReflection=(sinTh2>1);
  
        /* 折射光 */
        if(!totalReflection){
          var th2=Math.asin(sinTh2);
          var s2=Math.sin(th2), c2=Math.cos(th2);
          var rfEndX=OX+RLEN*s2, rfEndY=IFY+RLEN*c2;
          setL(el['ray-rf'], OX, IFY, rfEndX, rfEndY);
          if(el['ray-rf'])el['ray-rf'].setAttribute('opacity','1');
          if(el['total-ref'])el['total-ref'].setAttribute('opacity','0');
        }else{
          /* 全反射：无折射光 */
          if(el['ray-rf'])el['ray-rf'].setAttribute('opacity','0');
          if(el['total-ref']){
            el['total-ref'].setAttribute('opacity','1');
            el['total-ref'].textContent='⚡ 全反射！θ₁ > 临界角 '+
              (Math.asin(n2/n1)/DEG).toFixed(1)+'°';
          }
        }
  
        /* 反射光（可选，较淡虚线） */
        if(showReflect){
          var rlEndX=OX+RLEN*s1, rlEndY=IFY-RLEN*c1;
          setL(el['ray-rl'], OX, IFY, rlEndX, rlEndY);
          if(el['ray-rl'])el['ray-rl'].setAttribute('opacity', totalReflection?'0.8':'0.35');
        }
  
        /* 角度弧 */
        if(showLabels&&angle>1){
          var R=28;
  
          /*
           * 入射角弧（上方，法线与入射光之间）
           * 法线向上: 端点 = (OX, IFY-R)
           * 来光方向: 端点 = (OX-R·sinθ₁, IFY-R·cosθ₁)
           *
           * 法线向上 N = (OX, IFY-R) 在正上方
           * 来光点 I = (OX-R·s1, IFY-R·c1) 在左上方
           *
           * I 在 N 的左下方（x更小, y更大）
           * 从 N 到 I:
           *   sweep=0(逆时针): N→左→I = 短弧（经过左侧）✓
           *   sweep=1(顺时针): N→右→下→左→I = 大弧 ✗
           */
          var nUpX=OX, nUpY=IFY-R;
          var iPtX=OX-R*s1, iPtY=IFY-R*c1;
  
          if(el['arc1'])el['arc1'].setAttribute('d',
            'M'+nUpX+','+nUpY+
            ' A'+R+','+R+' 0 0,0 '+iPtX.toFixed(1)+','+iPtY.toFixed(1));
  
          if(el['arc1t']){
            var h1=th1/2;
            var tR1=R+16;
            el['arc1t'].setAttribute('x',(OX-tR1*Math.sin(h1)-2).toFixed(1));
            el['arc1t'].setAttribute('y',(IFY-tR1*Math.cos(h1)+4).toFixed(1));
            el['arc1t'].textContent='θ₁='+Math.round(angle)+'°';
          }
  
          /* 折射角弧（下方，法线与折射光之间） */
          if(!totalReflection&&th2>0.02){
            /*
             * 法线向下: 端点 = (OX, IFY+R)
             * 折射方向: 端点 = (OX+R·sinθ₂, IFY+R·cosθ₂)
             *
             * 法线下 D = (OX, IFY+R) 在正下方
             * 折射点 F = (OX+R·s2, IFY+R·c2) 在右下���
             *
             * F 在 D 的右上方（x更大, y更小）
             * 从 D 到 F:
             *   sweep=0(逆时针): D→右→F = 短弧 ✓
             */
            var nDnX=OX, nDnY=IFY+R;
            var fPtX=OX+R*s2, fPtY=IFY+R*c2;
  
            if(el['arc2'])el['arc2'].setAttribute('d',
              'M'+nDnX+','+nDnY+
              ' A'+R+','+R+' 0 0,0 '+fPtX.toFixed(1)+','+fPtY.toFixed(1));
  
            if(el['arc2t']){
              var h2=th2/2;
              var tR2=R+16;
              el['arc2t'].setAttribute('x',(OX+tR2*Math.sin(h2)+2).toFixed(1));
              el['arc2t'].setAttribute('y',(IFY+tR2*Math.cos(h2)+4).toFixed(1));
              el['arc2t'].textContent='θ₂='+Math.round(th2/DEG)+'°';
            }
          }else{
            if(el['arc2'])el['arc2'].setAttribute('d','');
            if(el['arc2t'])el['arc2t'].textContent='';
          }
        }else{
          if(el['arc1'])el['arc1'].setAttribute('d','');
          if(el['arc1t'])el['arc1t'].textContent='';
          if(el['arc2'])el['arc2'].setAttribute('d','');
          if(el['arc2t'])el['arc2t'].textContent='';
        }
  
        /* 拖拽点（入射光中点） */
        var mx=(srcX+OX)/2, my=(srcY+IFY)/2;
        if(el['dot1']){el['dot1'].setAttribute('cx',mx);el['dot1'].setAttribute('cy',my);}
        if(el['dot2']){el['dot2'].setAttribute('cx',mx);el['dot2'].setAttribute('cy',my);}
        if(el['hit']){
          el['hit'].setAttribute('x',mx-22);el['hit'].setAttribute('y',my-22);
          el['hit'].setAttribute('width',44);el['hit'].setAttribute('height',44);
        }
  
        /* 数据面板 */
        if(showData){
          var a1=Math.round(angle);
          if(el['d1'])el['d1'].textContent='n₁ = '+n1.toFixed(2)+' ('+m1Name+')   n₂ = '+n2.toFixed(2)+' ('+m2Name+')';
          if(el['d2'])el['d2'].textContent='入射角 θ₁ = '+a1+'°';
          if(totalReflection){
            if(el['d3'])el['d3'].textContent='全反射！临界角 = '+(Math.asin(n2/n1)/DEG).toFixed(1)+'°';
            if(el['d4'])el['d4'].textContent='n₁ > n₂ 且 θ₁ > 临界角时发生全反射';
          }else{
            var a2=Math.round(Math.asin(sinTh2)/DEG);
            if(el['d3'])el['d3'].textContent='折射角 θ₂ = '+a2+'°';
            var desc='';
            if(n1<n2) desc='光从疏→密：折射角 < 入射角（偏向法线）';
            else if(n1>n2) desc='光从密→疏：折射角 > 入射角（偏离法线）';
            else desc='同种介质：折射角 = 入射角（不偏折）';
            if(el['d4'])el['d4'].textContent=desc;
          }
        }
  
        root.setAttribute('aria-label','光的折射 θ₁='+Math.round(angle)+'°');
      }
  
      render();
  
      /* ─── 事件派发 ─── */
      function emitCmp(name){
        root.dispatchEvent(new CustomEvent(name,{
          bubbles:true, composed:true,
          detail:{
            id:root.getAttribute('data-cmp-id'),
            type:'slide',
            values:{ angle:angle }
          }
        }));
      }

      /* ─── 拖拽 ─── */
      var dragging=false;
  
      function calcAngle(cx,cy){
        var rect=svg.getBoundingClientRect();
        var sx=(cx-rect.left)/(rect.width/VB_W);
        var sy=(cy-rect.top)/(rect.height/VB_H);
        /* 鼠标相对于入射点 O(240,200) */
        var dx=sx-OX, dy=sy-IFY;
        /* 只响应上半区域(dy<0)且左侧(dx<0) */
        if(dy>=0) return angle;
        /* 入射角 = 与法线(竖直)的夹角 = atan(|dx|/|dy|) */
        return Math.max(0, Math.min(85, Math.atan2(Math.abs(dx),Math.abs(dy))/DEG));
      }
  
      function onD(e){
        e.preventDefault();dragging=true;
        document.addEventListener('mousemove',onM,{passive:false});
        document.addEventListener('mouseup',onU);
        document.addEventListener('touchmove',onM,{passive:false});
        document.addEventListener('touchend',onU);
      }
      function onM(e){
        if(!dragging)return;e.preventDefault();
        var pt=e.touches?e.touches[0]:e;
        angle=calcAngle(pt.clientX,pt.clientY);
        render();
        emitCmp('cmp:change');
      }
      function onU(){
        dragging=false;
        emitCmp('cmp:changeend');
        document.removeEventListener('mousemove',onM);
        document.removeEventListener('mouseup',onU);
        document.removeEventListener('touchmove',onM);
        document.removeEventListener('touchend',onU);
      }
  
      var tgt=root.querySelector('.rfr__drag');
      if(tgt){
        tgt.addEventListener('mousedown',onD,{passive:false});
        tgt.addEventListener('touchstart',onD,{passive:false});
      }
  
      window.addEventListener('beforeunload',function(){
        if(tgt){tgt.removeEventListener('mousedown',onD);tgt.removeEventListener('touchstart',onD);}
        document.removeEventListener('mousemove',onM);document.removeEventListener('mouseup',onU);
        document.removeEventListener('touchmove',onM);document.removeEventListener('touchend',onU);
      });
    })();
    </script>
  </div>