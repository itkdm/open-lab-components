<!-- @cmp-manifest
{
  "schema": "cmp-manifest/v1",
  "id": "phy.circuit.electromagnet.interactive",
  "name": "电磁铁（交互式）",
  "nameEn": "Electromagnet (Interactive)",
  "category": "physics/circuit",
  "version": "1.1.0",
  "viewport": { "w": 300, "h": 200 },
  "tags": ["electromagnet", "magnet", "coil", "circuit", "interactive", "magnetic-field"],
  "props": [
    { "key": "size",       "type": "number(px)", "default": 200, "min": 120, "max": 400, "desc": "组件高度（宽度按比例缩放）" },
    { "key": "coilColor",  "type": "color",  "default": "#b87333", "desc": "线圈颜色（铜色）" },
    { "key": "coreColor",  "type": "color",  "default": "#666666", "desc": "铁芯颜色" },
    { "key": "fieldColor", "type": "color",  "default": "#2196f3", "desc": "磁力线颜色" },
    { "key": "nailColor",  "type": "color",  "default": "#888888", "desc": "铁钉颜色" },
    { "key": "wireColor",  "type": "color",  "default": "#d32f2f", "desc": "导线颜色" },
    { "key": "stroke",     "type": "color",  "default": "#222222", "desc": "描边颜色" },
    { "key": "strokeWidth","type": "number", "default": 1.5, "min": 0.5, "max": 4, "desc": "描边粗细" },
    { "key": "powered",    "type": "enum",   "default": "off", "enum": ["on","off"], "desc": "初始通电状态" },
    { "key": "glow",       "type": "number(0-1)", "default": 0, "min": 0, "max": 1, "desc": "强调/亮度" }
  ],
  "cssVars": {
    "size":       "--cmp-size",
    "coilColor":  "--cmp-coil",
    "coreColor":  "--cmp-core",
    "fieldColor": "--cmp-field",
    "nailColor":  "--cmp-nail",
    "wireColor":  "--cmp-wire",
    "stroke":     "--cmp-stroke",
    "strokeWidth":"--cmp-stroke-width",
    "glow":       "--cmp-glow"
  },
  "events": [
    { "name": "cmp:change", "type": "toggle", "values": { "powered": "boolean — 是否通电" } }
  ]
}
-->
<div class="cmp" data-cmp-id="phy.circuit.electromagnet.interactive" role="img" aria-label="电磁铁（断电）">
  <style>
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] {
      --h: var(--cmp-size, 200px);
      display: inline-block;
      width: calc(var(--h) * 1.5);
      height: var(--h);
      filter: drop-shadow(0 0 calc(6px * var(--cmp-glow, 0))
              rgba(255,214,102, calc(0.8 * var(--cmp-glow, 0))));
      user-select: none;
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] svg {
      width: 100%; height: 100%; display: block; overflow: visible;
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] .em__btn {
      cursor: pointer;
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] .em__field-line {
      opacity: 0; transition: opacity 0.5s ease;
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] .em__nail {
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"][data-powered="on"] .em__field-line {
      opacity: 0.55;
    }
    /* 铁钉被吸向铁芯左端（N极） */
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"][data-powered="on"] .em__nail-1 {
      transform: translate(16px, 0);
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"][data-powered="on"] .em__nail-2 {
      transform: translate(20px, 2px);
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"][data-powered="on"] .em__nail-3 {
      transform: translate(14px, -2px);
    }
    .cmp[data-cmp-id="phy.circuit.electromagnet.interactive"] .em__indicator {
      transition: fill 0.3s ease;
    }
  </style>

  <svg viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <linearGradient id="em__core-g" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0"   stop-color="#aaa"/>
        <stop offset="0.5" stop-color="var(--cmp-core, #666)"/>
        <stop offset="1"   stop-color="#444"/>
      </linearGradient>
    </defs>

    <!-- ═══ 导线回路 ═══ -->
    <!-- 上导线：从开关右端 → 线圈左端 -->
    <path d="M68,165 L68,120 L90,120 L90,82" fill="none"
          stroke="var(--cmp-wire, #d32f2f)" stroke-width="2.5" stroke-linecap="round"/>
    <!-- 下导线：从线圈右端 → 底部 → 开关左端 -->
    <path d="M210,82 L210,120 L240,120 L240,180 L68,180 L68,175" fill="none"
          stroke="var(--cmp-wire, #d32f2f)" stroke-width="2.5" stroke-linecap="round"/>

    <!-- ═══ 铁芯（长条，两端露出作为磁极） ═══ -->
    <rect x="70" y="62" width="160" height="20" rx="3"
          fill="url(#em__core-g)"
          stroke="var(--cmp-stroke, #222)" stroke-width="var(--cmp-stroke-width, 1.5)"/>

    <!-- ═══ 线圈（中段缠绕，用交替弧线模拟螺旋） ═══ -->
    <!-- 后半圈（铁芯后面） -->
    <g stroke="var(--cmp-coil, #b87333)" stroke-width="3" fill="none" opacity="0.5">
      <path d="M100,60 A8,14 0 0,0 100,84"/>
      <path d="M112,60 A8,14 0 0,0 112,84"/>
      <path d="M124,60 A8,14 0 0,0 124,84"/>
      <path d="M136,60 A8,14 0 0,0 136,84"/>
      <path d="M148,60 A8,14 0 0,0 148,84"/>
      <path d="M160,60 A8,14 0 0,0 160,84"/>
      <path d="M172,60 A8,14 0 0,0 172,84"/>
      <path d="M184,60 A8,14 0 0,0 184,84"/>
      <path d="M196,60 A8,14 0 0,0 196,84"/>
    </g>
    <!-- 连接斜线（螺旋感） -->
    <g stroke="var(--cmp-coil, #b87333)" stroke-width="2" fill="none" opacity="0.4">
      <line x1="100" y1="60" x2="112" y2="60"/>
      <line x1="112" y1="84" x2="124" y2="84"/>
      <line x1="124" y1="60" x2="136" y2="60"/>
      <line x1="136" y1="84" x2="148" y2="84"/>
      <line x1="148" y1="60" x2="160" y2="60"/>
      <line x1="160" y1="84" x2="172" y2="84"/>
      <line x1="172" y1="60" x2="184" y2="60"/>
      <line x1="184" y1="84" x2="196" y2="84"/>
    </g>
    <!-- 前半圈（铁芯前面，覆盖） -->
    <g stroke="var(--cmp-coil, #b87333)" stroke-width="3" fill="none">
      <path d="M100,60 A8,14 0 0,1 100,84"/>
      <path d="M112,60 A8,14 0 0,1 112,84"/>
      <path d="M124,60 A8,14 0 0,1 124,84"/>
      <path d="M136,60 A8,14 0 0,1 136,84"/>
      <path d="M148,60 A8,14 0 0,1 148,84"/>
      <path d="M160,60 A8,14 0 0,1 160,84"/>
      <path d="M172,60 A8,14 0 0,1 172,84"/>
      <path d="M184,60 A8,14 0 0,1 184,84"/>
      <path d="M196,60 A8,14 0 0,1 196,84"/>
    </g>

    <!-- ═══ N/S 极标注（铁芯露出的两端） ═══ -->
    <text x="80" y="58" text-anchor="middle" font-size="13" font-weight="700"
          fill="#f44336" font-family="Arial, sans-serif">N</text>
    <text x="220" y="58" text-anchor="middle" font-size="13" font-weight="700"
          fill="#2196f3" font-family="Arial, sans-serif">S</text>

    <!-- ═══ 磁力线（通电后显示，N→S 外部） ═══ -->
    <g class="em__field-line" fill="none" stroke="var(--cmp-field, #2196f3)" stroke-width="1">
      <!-- 上方弧线 -->
      <path d="M78,68 C78,30 222,30 222,68" stroke-dasharray="4,3"/>
      <path d="M78,68 C78,14 222,14 222,68" stroke-dasharray="4,3"/>
      <path d="M78,68 C78,46 222,46 222,68" stroke-dasharray="4,3"/>
      <!-- 下方弧线 -->
      <path d="M78,78 C78,110 222,110 222,78" stroke-dasharray="4,3"/>
      <path d="M78,78 C78,126 222,126 222,78" stroke-dasharray="4,3"/>
      <!-- 箭头（弧线中段，朝右 = N→S） -->
      <polygon fill="var(--cmp-field, #2196f3)" points="146,24 154,29 146,34" opacity="0.8"/>
      <polygon fill="var(--cmp-field, #2196f3)" points="146,40 154,45 146,50" opacity="0.8"/>
      <polygon fill="var(--cmp-field, #2196f3)" points="146,104 154,109 146,114" opacity="0.8"/>
    </g>

    <!-- ═══ 铁钉（散落在 N 极左侧，通电后被吸向铁芯） ═══ -->
    <g class="em__nail em__nail-1">
      <rect x="38" y="66" width="18" height="3" rx="1"
            fill="var(--cmp-nail, #888)"
            stroke="var(--cmp-stroke, #222)" stroke-width="0.8"/>
      <circle cx="37" cy="67.5" r="2" fill="var(--cmp-nail, #888)"
              stroke="var(--cmp-stroke, #222)" stroke-width="0.6"/>
    </g>
    <g class="em__nail em__nail-2">
      <rect x="32" y="74" width="16" height="3" rx="1"
            fill="var(--cmp-nail, #888)"
            stroke="var(--cmp-stroke, #222)" stroke-width="0.8"/>
      <circle cx="31" cy="75.5" r="2" fill="var(--cmp-nail, #888)"
              stroke="var(--cmp-stroke, #222)" stroke-width="0.6"/>
    </g>
    <g class="em__nail em__nail-3">
      <rect x="42" y="58" width="15" height="3" rx="1"
            fill="var(--cmp-nail, #888)"
            stroke="var(--cmp-stroke, #222)" stroke-width="0.8"/>
      <circle cx="41" cy="59.5" r="2" fill="var(--cmp-nail, #888)"
              stroke="var(--cmp-stroke, #222)" stroke-width="0.6"/>
    </g>

    <!-- ═══ 开关按钮（串联在导线回路中） ═══ -->
    <g class="em__btn">
      <rect x="50" y="160" width="36" height="22" rx="4"
            fill="#e8e8e8" stroke="var(--cmp-stroke, #222)" stroke-width="1.2"/>
      <circle class="em__indicator" cx="68" cy="171" r="5" fill="#999"
              stroke="var(--cmp-stroke, #222)" stroke-width="0.8"/>
    </g>
    <text x="68" y="194" text-anchor="middle" font-size="8"
          fill="var(--cmp-stroke, #222)" font-family="Arial, sans-serif">ON / OFF</text>
  </svg>
</div>

<script>
(function() {
  var script = document.currentScript;
  if (!script) return;
  var root = script.previousElementSibling;
  if (!root || root.getAttribute('data-cmp-id') !== 'phy.circuit.electromagnet.interactive') return;

  var P = {};
  try {
    var raw = root.getAttribute('data-props');
    if (raw) { var o = JSON.parse(raw); if (o && typeof o === 'object') P = o; }
  } catch(e) {}

  var powered = (P.powered === 'on');
  var indicator = root.querySelector('.em__indicator');
  var btn = root.querySelector('.em__btn');

  function applyState() {
    root.setAttribute('data-powered', powered ? 'on' : 'off');
    if (indicator) indicator.setAttribute('fill', powered ? '#4caf50' : '#999');
    root.setAttribute('aria-label', '电磁铁（' + (powered ? '通电' : '断电') + '）');
  }

  function emitCmp() {
    root.dispatchEvent(new CustomEvent('cmp:change', {
      bubbles: true, composed: true,
      detail: {
        id: root.getAttribute('data-cmp-id'),
        type: 'toggle',
        values: { powered: powered }
      }
    }));
  }

  applyState();

  if (btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      powered = !powered;
      applyState();
      emitCmp();
    });
  }
})();
</script>
