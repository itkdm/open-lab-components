<!-- @cmp-manifest
{
  "schema": "cmp-manifest/v1",
  "id": "phy.apparatus.pulley-fixed.interactive",
  "name": "定滑轮（交互式）",
  "nameEn": "Fixed Pulley (Interactive)",
  "category": "physics/apparatus",
  "version": "1.5.0",
  "viewport": { "w": 200, "h": 340 },
  "props": [
    { "key": "size",         "type": "number(px)", "default": 340, "min": 200, "max": 600, "desc": "组件高度（宽度按比例缩放）" },
    { "key": "stroke",       "type": "color",  "default": "#333333", "desc": "描边颜色" },
    { "key": "strokeWidth",  "type": "number", "default": 2,   "min": 0.5, "max": 5, "desc": "描边粗细" },
    { "key": "wheelColor",   "type": "color",  "default": "#b0b0b0", "desc": "滑轮颜色" },
    { "key": "wheelEdge",    "type": "color",  "default": "#888888", "desc": "滑轮边缘深色" },
    { "key": "axleColor",    "type": "color",  "default": "#555555", "desc": "轴心颜色" },
    { "key": "bracketColor", "type": "color",  "default": "#666666", "desc": "支架颜色" },
    { "key": "ropeColor",    "type": "color",  "default": "#8B7355", "desc": "绳索颜色" },
    { "key": "ropeWidth",    "type": "number", "default": 3,   "min": 1.5, "max": 8, "desc": "绳索粗细" },
    { "key": "ropeBottom",   "type": "number", "default": 290, "min": 200, "max": 330, "desc": "绳索末端最大Y（控制绳索总长度）" },
    { "key": "loadMass",     "type": "number", "default": 200, "min": 0, "max": 5000, "desc": "负载质量(g)" },
    { "key": "unit",         "type": "enum",   "default": "g", "enum": ["g","kg"], "desc": "质量单位" },
    { "key": "blockEdge",    "type": "color",  "default": "#bdbdbd", "desc": "砝码边缘色" },
    { "key": "blockCenter",  "type": "color",  "default": "#e7e7e7", "desc": "砝码中心色" },
    { "key": "hookColor",    "type": "color",  "default": "#111827", "desc": "钩子颜色" },
    { "key": "blockScale",   "type": "number", "default": 1,   "min": 0.5, "max": 2, "desc": "砝码尺寸缩放（相对默认大小）" },
    { "key": "accent",       "type": "color",  "default": "#1565c0", "desc": "强调色（力值文字）" },
    { "key": "glow",         "type": "number(0-1)", "default": 0, "min": 0, "max": 1, "desc": "强调/亮度（可选）" }
  ],
  "cssVars": {
    "size":         "--cmp-size",
    "stroke":       "--cmp-stroke",
    "strokeWidth":  "--cmp-stroke-width",
    "wheelColor":   "--cmp-wheel",
    "wheelEdge":    "--cmp-wheel-edge",
    "axleColor":    "--cmp-axle",
    "bracketColor": "--cmp-bracket",
    "ropeColor":    "--cmp-rope",
    "ropeWidth":    "--cmp-rope-width",
    "blockEdge":    "--cmp-block-edge",
    "blockCenter":  "--cmp-block-center",
    "hookColor":    "--cmp-hook",
    "accent":       "--cmp-accent",
    "glow":         "--cmp-glow"
  },
  "tags": ["pulley", "fixed-pulley", "simple-machine", "mechanics", "interactive", "draggable"],
  "events": [
    { "name": "cmp:change", "type": "adjust", "values": { "ratio": "number(0-1) — 拉绳比例", "force": "number(N) — 拉力" } },
    { "name": "cmp:changeend", "type": "adjust", "values": { "ratio": "number(0-1) — 拉绳比例", "force": "number(N) — 拉力" } }
  ]
}
-->
<div class="cmp" data-cmp-id="phy.apparatus.pulley-fixed.interactive" role="img" aria-label="定滑轮（交互式）">
    <style>
      .cmp[data-cmp-id="phy.apparatus.pulley-fixed.interactive"] {
        --h: var(--cmp-size, 340px);
        display: inline-block;
        width: calc(var(--h) * 0.588);
        height: var(--h);
        filter: drop-shadow(0 0 calc(8px * var(--cmp-glow, 0))
                rgba(255,214,102, calc(0.8 * var(--cmp-glow, 0))));
        user-select: none;
        touch-action: none;
      }
      .cmp[data-cmp-id="phy.apparatus.pulley-fixed.interactive"] svg {
        width: 100%; height: 100%; display: block; overflow: visible;
      }
      .cmp[data-cmp-id="phy.apparatus.pulley-fixed.interactive"] .ipl__handle {
        cursor: ns-resize;
      }
      .cmp[data-cmp-id="phy.apparatus.pulley-fixed.interactive"] .ipl__force-text {
        font-family: 'Courier New', Courier, monospace;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
      }
      .cmp[data-cmp-id="phy.apparatus.pulley-fixed.interactive"] .ipl__mass-text {
        font-family: Arial, sans-serif;
        font-weight: 800;
        font-size: 12px;
        fill: rgba(0, 0, 0, 0.92);
      }
    </style>
  
    <svg viewBox="0 0 200 340" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <radialGradient id="ipl__wg" cx="0.4" cy="0.35" r="0.6">
          <stop offset="0"    stop-color="var(--cmp-wheel, #b0b0b0)"/>
          <stop offset="0.85" stop-color="var(--cmp-wheel, #b0b0b0)"/>
          <stop offset="1"    stop-color="var(--cmp-wheel-edge, #888)"/>
        </radialGradient>
        <linearGradient id="ipl__bg" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0"   stop-color="var(--cmp-bracket, #666)"/>
          <stop offset="0.5" stop-color="#999"/>
          <stop offset="1"   stop-color="var(--cmp-bracket, #666)"/>
        </linearGradient>
        <linearGradient id="ipl__block" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0"   stop-color="var(--cmp-block-edge, #bdbdbd)"/>
          <stop offset="0.5" stop-color="var(--cmp-block-center, #e7e7e7)"/>
          <stop offset="1"   stop-color="var(--cmp-block-edge, #bdbdbd)"/>
        </linearGradient>
      </defs>
  
      <!-- ═══ 1. 天花板横梁 ═══ -->
      <rect x="50" y="0" width="100" height="12" rx="3"
            fill="#4a4a4a" stroke="var(--cmp-stroke, #333)" stroke-width="1.5"/>
  
      <!-- ═══ 2. 连接杆 ═══ -->
      <line x1="100" y1="12" x2="100" y2="38"
            stroke="var(--cmp-bracket, #666)" stroke-width="5" stroke-linecap="round"/>
  
      <!-- ═══ 3. 支架 ═══ -->
      <line x1="100" y1="38" x2="78" y2="56"
            stroke="url(#ipl__bg)" stroke-width="4.5" stroke-linecap="round"/>
      <line x1="100" y1="38" x2="122" y2="56"
            stroke="url(#ipl__bg)" stroke-width="4.5" stroke-linecap="round"/>
      <line x1="78" y1="56" x2="78" y2="74"
            stroke="url(#ipl__bg)" stroke-width="3.5" stroke-linecap="round"/>
      <line x1="122" y1="56" x2="122" y2="74"
            stroke="url(#ipl__bg)" stroke-width="3.5" stroke-linecap="round"/>
  
      <!-- ═══ 4. 绳索 ═══ -->
      <path class="ipl__rope-arc"
            d="M74,74 A26,26 0 1,1 126,74"
            fill="none"
            stroke="var(--cmp-rope, #8B7355)"
            stroke-width="var(--cmp-rope-width, 3)"
            stroke-linecap="round"/>
      <line class="ipl__rope-left"
            x1="74" y1="74" x2="74" y2="198"
            stroke="var(--cmp-rope, #8B7355)"
            stroke-width="var(--cmp-rope-width, 3)"
            stroke-linecap="round"/>
      <line class="ipl__rope-right"
            x1="126" y1="74" x2="126" y2="176"
            stroke="var(--cmp-rope, #8B7355)"
            stroke-width="var(--cmp-rope-width, 3)"
            stroke-linecap="round"/>
  
      <!-- ═══ 5. 滑轮 ═══ -->
      <circle cx="100" cy="74" r="30"
              fill="url(#ipl__wg)" stroke="var(--cmp-stroke, #333)"
              stroke-width="var(--cmp-stroke-width, 2)"/>
      <circle cx="100" cy="74" r="26" fill="none"
              stroke="var(--cmp-wheel-edge, #888)" stroke-width="1.2"
              stroke-dasharray="4,3" opacity="0.35"/>
      <g class="ipl__spokes" stroke="var(--cmp-wheel-edge, #888)" stroke-width="1" opacity="0.4">
        <line x1="100" y1="48" x2="100" y2="100"/>
        <line x1="74"  y1="74" x2="126" y2="74"/>
        <line x1="81.6" y1="55.6" x2="118.4" y2="92.4"/>
        <line x1="118.4" y1="55.6" x2="81.6" y2="92.4"/>
      </g>
      <circle cx="100" cy="74" r="6" fill="var(--cmp-axle, #555)"
              stroke="var(--cmp-stroke, #333)" stroke-width="1.5"/>
      <circle cx="100" cy="74" r="2.5" fill="#777"/>
  
      <!-- ═══ 6. 右侧负载 ═══ -->
      <g class="ipl__load">
        <!-- 绳钩（向下开口，连接绳索末端） -->
        <path class="ipl__rope-hook" fill="none"
              stroke="var(--cmp-hook, #111827)"
              stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        <!-- 砝码钩（向上开口，连接砝码顶部） -->
        <path class="ipl__load-hook" fill="none"
              stroke="var(--cmp-hook, #111827)"
              stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        <!-- 砝码块 -->
        <rect class="ipl__load-block" width="48" height="56" rx="1"
              fill="url(#ipl__block)" stroke="var(--cmp-stroke, #333)"
              stroke-width="1.4"/>
        <!-- 质量文字 -->
        <text class="ipl__mass-text" text-anchor="middle"></text>
      </g>
  
      <!-- ═══ 7. 左侧施力端 ═══ -->
      <g class="ipl__handle">
        <circle class="ipl__pull-dot" cx="74" cy="198" r="5"
                fill="var(--cmp-accent, #1565c0)" opacity="0.7"/>
        <line class="ipl__pull-line"
              x1="74" y1="206" x2="74" y2="232"
              stroke="var(--cmp-accent, #1565c0)"
              stroke-width="2.5" stroke-linecap="round"/>
        <polygon class="ipl__pull-arrow"
                 points="68,230 74,242 80,230"
                 fill="var(--cmp-accent, #1565c0)"/>
        <rect class="ipl__hit"
              x="49" y="188" width="50" height="60"
              fill="transparent" cursor="ns-resize"/>
        <text class="ipl__force-text"
              x="74" y="260" text-anchor="middle"
              font-size="11" fill="var(--cmp-accent, #1565c0)">1.96 N</text>
      </g>
    </svg>
  
    <script>
    (function() {
      var script = document.currentScript;
      if (!script) return;
      var root = script.parentElement;
      if (!root || root.getAttribute('data-cmp-id') !== 'phy.apparatus.pulley-fixed.interactive') return;
  
      var svg = root.querySelector('svg');
      if (!svg) return;
  
      /* ─── 参数 ─── */
      var P = {};
      try {
        var raw = root.getAttribute('data-props');
        if (raw) { var o = JSON.parse(raw); if (o && typeof o === 'object') P = o; }
      } catch(e) {}
  
      var loadMass = Math.max(0, Number(P.loadMass) || 200);
      var massUnit = (P.unit === 'kg') ? 'kg' : 'g';
      var blockScale = Number(P.blockScale);
      if (!isFinite(blockScale) || blockScale <= 0) blockScale = 1;
      blockScale = Math.max(0.5, Math.min(2, blockScale));
  
      /* ─── 几何 ─── */
      var CX = 100, CY = 74, R = 26;
      var LX = CX - R;          /* 74 */
      var RX = CX + R;          /* 126 */
      var ROPE_TOP = CY;        /* 74 */
      var ropeBottom = Number(P.ropeBottom);
      if (!isFinite(ropeBottom)) ropeBottom = 290;
      ropeBottom = Math.max(200, Math.min(330, ropeBottom));
      var TRAVEL = ropeBottom - ROPE_TOP;
  
      var ratio = 0.55;
  
      /* ─── DOM ─── */
      var ropeArc   = root.querySelector('.ipl__rope-arc');
      var ropeLeft  = root.querySelector('.ipl__rope-left');
      var ropeRight = root.querySelector('.ipl__rope-right');
      var spokes    = root.querySelector('.ipl__spokes');
  
      var ropeHook  = root.querySelector('.ipl__rope-hook');
      var loadHook  = root.querySelector('.ipl__load-hook');
      var loadBlock = root.querySelector('.ipl__load-block');
      var massTxt   = root.querySelector('.ipl__mass-text');
  
      var pullDot   = root.querySelector('.ipl__pull-dot');
      var pullLine  = root.querySelector('.ipl__pull-line');
      var pullArrow = root.querySelector('.ipl__pull-arrow');
      var hitRect   = root.querySelector('.ipl__hit');
      var forceTxt  = root.querySelector('.ipl__force-text');
  
      /* ─── 渲染 ─── */
      function render() {
        var leftY  = ROPE_TOP + ratio * TRAVEL;
        var rightY = ropeBottom - ratio * TRAVEL;
  
        /* 绳索弧 */
        if (ropeArc) {
          ropeArc.setAttribute('d',
            'M' + LX + ',' + CY + ' A' + R + ',' + R + ' 0 1,1 ' + RX + ',' + CY);
        }
        /* 左绳 */
        if (ropeLeft) {
          ropeLeft.setAttribute('x1', LX); ropeLeft.setAttribute('y1', CY);
          ropeLeft.setAttribute('x2', LX); ropeLeft.setAttribute('y2', leftY);
        }
        /* 右绳 */
        if (ropeRight) {
          ropeRight.setAttribute('x1', RX); ropeRight.setAttribute('y1', CY);
          ropeRight.setAttribute('x2', RX); ropeRight.setAttribute('y2', rightY);
        }
        /* 辐条旋转 */
        if (spokes) {
          var deg = ratio * 360;
          spokes.setAttribute('transform',
            'rotate(' + deg.toFixed(1) + ',' + CX + ',' + CY + ')');
        }
  
        /* ─── 右侧：双钩子 + 砝码 ─── */
        /*
         * 布局（从上到下）：
         *   rightY        = 绳末端
         *   绳钩（向下开口）：rightY → rightY+18
         *   连接点         ：rightY+18（两钩互扣处）
         *   砝码钩（向上开口）：rightY+12 → rightY+28
         *   砝码块         ：rightY+28 → rightY+28+56
         */
        var hookJoinY = rightY + 18; /* 两钩交汇处 */
  
        /* 绳钩：从绳末端向下，弯成倒问号形（开口朝下）
         * 形状：竖线下来 → 向右弯弧 → 翻上来一点（形成钩尖）
         * 参考 phy.weight.hook.realistic 的路径，但上下翻转
         * 原始（开口朝上）：M40,22 C40,14 56,14 56,22 C56,29 49,28 48,32 L48,36
         * 翻转（开口朝下）：从顶部下来，弧线向下弯
         */
        if (ropeHook) {
          var rhy = rightY; /* 绳末端 y */
          ropeHook.setAttribute('d',
            'M' + RX + ',' + rhy +
            ' L' + RX + ',' + (rhy + 4) +
            ' C' + RX + ',' + (rhy + 14) +
            ' ' + (RX - 16) + ',' + (rhy + 14) +
            ' ' + (RX - 16) + ',' + (rhy + 4) +
            ' C' + (RX - 16) + ',' + (rhy - 2) +
            ' ' + (RX - 9) + ',' + (rhy - 1) +
            ' ' + (RX - 8) + ',' + (rhy + 3));
        }
  
        /* 砝码钩：向上开口的问号形（和 phy.weight.hook.realistic 一致）
         * 原始路径以 x=48 为中心，这里以 RX 为中心
         * 钩子高度约 14 单位（22→36），宽度约 16（40→56）
         */
        var whY = hookJoinY - 4; /* 砝码钩顶部 y（比交汇处稍高，形成互扣） */
        var whCX = RX;           /* 以绳 x 为中心 */
        if (loadHook) {
          loadHook.setAttribute('d',
            'M' + (whCX - 8) + ',' + (whY + 0) +
            ' C' + (whCX - 8) + ',' + (whY - 8) +
            ' ' + (whCX + 8) + ',' + (whY - 8) +
            ' ' + (whCX + 8) + ',' + (whY + 0) +
            ' C' + (whCX + 8) + ',' + (whY + 7) +
            ' ' + (whCX + 1) + ',' + (whY + 6) +
            ' ' + whCX + ',' + (whY + 10) +
            ' L' + whCX + ',' + (whY + 14));
        }
  
        /* 砝码块（随 blockScale 缩放宽高与位置） */
        var baseW = 48, baseH = 56;
        var bw = baseW * blockScale;
        var bh = baseH * blockScale;
        var bx = RX - bw / 2;
        var by = whY + 14 * blockScale;
        if (loadBlock) {
          loadBlock.setAttribute('width', bw);
          loadBlock.setAttribute('height', bh);
          loadBlock.setAttribute('x', bx);
          loadBlock.setAttribute('y', by);
        }
        /* 质量文字 */
        if (massTxt) {
          var mStr = (massUnit === 'kg')
            ? (Math.round(loadMass * 100) / 100) + ' kg'
            : Math.round(loadMass) + ' g';
          massTxt.textContent = mStr;
          massTxt.setAttribute('x', RX);
          massTxt.setAttribute('y', by + 33 * blockScale);
        }
  
        /* ─── 左侧：施力端 ─── */
        if (pullDot) {
          pullDot.setAttribute('cx', LX);
          pullDot.setAttribute('cy', leftY);
        }
        var lineStart = leftY + 8;
        var lineEnd   = leftY + 35;
        if (pullLine) {
          pullLine.setAttribute('x1', LX); pullLine.setAttribute('y1', lineStart);
          pullLine.setAttribute('x2', LX); pullLine.setAttribute('y2', lineEnd);
        }
        if (pullArrow) {
          pullArrow.setAttribute('points',
            (LX - 6) + ',' + (lineEnd - 2) + ' ' +
            LX + ',' + (lineEnd + 8) + ' ' +
            (LX + 6) + ',' + (lineEnd - 2));
        }
        if (hitRect) {
          hitRect.setAttribute('x', LX - 25);
          hitRect.setAttribute('y', leftY - 10);
        }
        var massKg = (massUnit === 'kg') ? loadMass : loadMass / 1000;
        var force = massKg * 9.8;
        if (forceTxt) {
          forceTxt.textContent = force.toFixed(2) + ' N';
          forceTxt.setAttribute('x', LX);
          forceTxt.setAttribute('y', lineEnd + 24);
        }
  
        root.setAttribute('aria-label',
          '定滑轮（交互式），负载 ' + Math.round(loadMass) + ' ' + massUnit +
          '，施力 ' + force.toFixed(2) + ' N');
      }
  
      function emitPulley(name) {
        var massKg_ = (massUnit === 'kg') ? loadMass : loadMass / 1000;
        var force_ = massKg_ * 9.8;
        root.dispatchEvent(new CustomEvent(name, {
          bubbles: true, composed: true,
          detail: { id: root.getAttribute('data-cmp-id'), type: 'adjust', values: { ratio: Math.round(ratio * 100) / 100, force: Math.round(force_ * 100) / 100 } }
        }));
      }

      render();

      /* ─── 拖拽 ─── */
      var dragging = false;
      var startClientY = 0, startRatio = 0;
  
      function onDown(e) {
        e.preventDefault();
        dragging = true;
        var pt = e.touches ? e.touches[0] : e;
        startClientY = pt.clientY;
        startRatio = ratio;
        document.addEventListener('mousemove', onMove, { passive: false });
        document.addEventListener('mouseup',   onUp);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend',  onUp);
      }
      function onMove(e) {
        if (!dragging) return;
        e.preventDefault();
        var pt = e.touches ? e.touches[0] : e;
        var rect = svg.getBoundingClientRect();
        var scale = rect.height / 340;
        var dy = (pt.clientY - startClientY) / scale;
        ratio = Math.max(0, Math.min(1, startRatio + dy / TRAVEL));
        render();
        emitPulley('cmp:change');
      }
      function onUp() {
        dragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup',   onUp);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend',  onUp);
        emitPulley('cmp:changeend');
      }
  
      var handle = root.querySelector('.ipl__handle');
      if (handle) {
        handle.addEventListener('mousedown',  onDown, { passive: false });
        handle.addEventListener('touchstart', onDown, { passive: false });
      }
    })();
    </script>
  </div>