<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»„ä»¶é¢„è§ˆ - Open Lab Components</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    :root {
      --primary: #059669;
      --primary-hover: #047857;
      --bg: #eff4ee;
      --surface: #ffffff;
      --border: #d1d5db;
      --border-light: #e5e7eb;
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --text-tertiary: #6b7280;
      --accent: #10b981;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 0.75rem;
      --radius-sm: 0.5rem;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
    }
    
    header {
      position: sticky;
      top: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--border-light);
      padding: 0;
      z-index: 100;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }
    
    .header-content {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 2rem;
      height: 64px;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .back-btn {
      padding: 0.5rem 0.875rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      line-height: 1.1;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: var(--bg);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .lang-btn {
      padding: 0.5rem 0.875rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-primary);
      margin-left: auto;
      line-height: 1.1;
      transition: all 0.2s;
    }
    
    .lang-btn:hover {
      background: var(--bg);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .header-info {
      flex: 1;
      min-width: 0;
      padding: 0 1rem;
    }
    
    .header-info h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.125rem;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .header-info p {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }
    
    .container {
      display: flex;
      height: calc(100vh - 64px);
      position: relative;
      z-index: 1;
    }
    
    .preview-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      min-width: 0;
      overflow: hidden;
    }
    
    .preview-content {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      padding: 0;
      background: var(--bg);
      overflow: auto;
      position: relative;
    }
    
    .preview-frame {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .controls-pane {
      width: 380px;
      background: var(--surface);
      overflow-y: auto;
      padding: 0;
      border-left: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
    }
    
    .controls-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .controls-footer {
      border-top: 1px solid var(--border-light);
      padding: 1.5rem;
      background: var(--surface);
      position: sticky;
      bottom: 0;
    }
    
    .controls-pane::-webkit-scrollbar {
      width: 8px;
    }
    
    .controls-pane::-webkit-scrollbar-track {
      background: var(--bg);
    }
    
    .controls-pane::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    .control-group {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-light);
    }
    
    .control-group:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .control-group h3 {
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    
    .control-item {
      margin-bottom: 1.5rem;
    }
    
    .control-item:last-child {
      margin-bottom: 0;
    }
    
    .control-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      margin-bottom: 0.625rem;
      color: var(--text-primary);
      line-height: 1.4;
    }
    
    .control-label small {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.375rem;
      font-weight: 400;
      line-height: 1.4;
    }
    
    input[type="range"],
    input[type="number"],
    input[type="text"],
    input[type="color"],
    select {
      width: 100%;
      padding: 0.625rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    input[type="range"] {
      padding: 0;
      height: 6px;
      background: var(--border-light);
      border-radius: 3px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-sm);
    }
    
    input[type="number"],
    input[type="text"],
    select {
      padding: 0.625rem 0.875rem;
    }
    
    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    input[type="color"] {
      height: 42px;
      padding: 0.25rem;
      cursor: pointer;
    }
    
    .range-input-group {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    
    .range-input-group input[type="range"] {
      flex: 1;
    }
    
    .range-input-group input[type="number"] {
      width: 80px;
      flex-shrink: 0;
    }
    
    .code-block {
      background: #1f2937;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
      font-size: 0.75rem;
      line-height: 1.6;
      overflow-x: auto;
      position: relative;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .code-block-header {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 10;
    }
    
    .code-block::before {
      content: 'HTML';
      font-size: 0.6875rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      pointer-events: none;
    }
    
    .code-copy-btn {
      background: rgba(75, 85, 99, 0.8);
      border: none;
      border-radius: 4px;
      color: #e5e7eb;
      cursor: pointer;
      padding: 0.375rem 0.625rem;
      font-size: 0.6875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.2s;
      pointer-events: auto;
    }
    
    .code-copy-btn:hover {
      background: rgba(107, 114, 128, 0.9);
      color: #ffffff;
    }
    
    .code-copy-btn:active {
      background: rgba(55, 65, 81, 0.9);
    }
    
    .code-copy-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .code-block code {
      color: #e5e7eb;
      white-space: pre;
      display: block;
    }
    
    .code-block::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .code-block::-webkit-scrollbar-track {
      background: #111827;
    }
    
    .code-block::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 3px;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      
      .controls-pane {
        width: 100%;
        max-height: 50vh;
        border-left: none;
        border-top: 1px solid var(--border-light);
      }
      
      .preview-pane {
        border-right: none;
        border-bottom: 1px solid var(--border-light);
      }
      
      .controls-footer {
        position: relative;
      }
    }
    
    @media (max-width: 768px) {
      .header-content {
        padding: 0 1rem;
        height: 56px;
      }
      
      .back-btn,
      .lang-btn {
        padding: 0.4375rem 0.75rem;
        font-size: 0.8125rem;
      }
      
      .header-info {
        padding: 0 0.5rem;
      }
      
      .header-info h1 {
        font-size: 1.125rem;
      }
      
      .header-info p {
        font-size: 0.75rem;
      }
      
      .container {
        height: calc(100vh - 56px);
      }
      
      .preview-content {
        padding: 0;
      }
      
      .preview-frame {
        width: 100%;
        height: 100%;
      }
      
      .controls-content {
        padding: 1.25rem;
      }
      
      .controls-footer {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="./index.html" class="back-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span data-i18n="back">è¿”å›</span>
      </a>
      <button id="langToggle" class="lang-btn" type="button">English</button>
      <div class="header-info">
      <h1 id="componentName">åŠ è½½ä¸­...</h1>
      <p id="componentMeta"></p>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="preview-pane">
      <div class="preview-content">
        <div class="preview-frame">
          <iframe id="previewFrame" style="border: none; width: 100%; height: 100%; display: block;"></iframe>
        </div>
      </div>
    </div>
    
    <div class="controls-pane">
      <div class="controls-content">
        <div id="controls">
          <div class="empty-state">
            <div class="empty-state-icon">âš™ï¸</div>
            <p data-i18n="loading-params">åŠ è½½ç»„ä»¶å‚æ•°ä¸­...</p>
          </div>
        </div>
      </div>
      
      <div class="controls-footer">
        <div class="control-group" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
          <h3 data-i18n="use-code">ä½¿ç”¨ä»£ç </h3>
        <div class="code-block">
            <div class="code-block-header">
              <button class="code-copy-btn" id="codeCopyBtn" onclick="copyCode()" title="å¤åˆ¶ä»£ç ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span data-i18n="btn-copy">å¤åˆ¶</span>
              </button>
            </div>
            <code id="codeOutput">åŠ è½½ä¸­...</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const componentId = urlParams.get('id');

    let component = null;
    let props = {};
    const LANG_KEY = 'olc-lang';
    const i18n = {
      zh: {
        'back': 'è¿”å›',
        'preview-title': 'å®æ—¶é¢„è§ˆ',
        'preview-desc': 'è°ƒæ•´å³ä¾§å‚æ•°æŸ¥çœ‹æ•ˆæœå˜åŒ–',
        'loading-params': 'åŠ è½½ç»„ä»¶å‚æ•°ä¸­...',
        'use-code': 'ä½¿ç”¨ä»£ç ',
        'no-component-title': 'ç»„ä»¶æœªæ‰¾åˆ°',
        'no-component-desc': 'è¯·æ£€æŸ¥ç»„ä»¶ ID æ˜¯å¦æ­£ç¡®',
        'back-home': 'è¿”å›é¦–é¡µ',
        'load-fail-title': 'åŠ è½½å¤±è´¥',
        'load-fail-desc-prefix': 'é”™è¯¯ï¼š',
        'no-config-title': 'å‚æ•°é…ç½®',
        'no-config-desc': 'è¯¥ç»„ä»¶æ— å¯é…ç½®å‚æ•°',
        'need-id-title': 'è¯·æŒ‡å®šç»„ä»¶ ID',
        'need-id-desc': 'è¯·åœ¨ URL ä¸­æ·»åŠ  ?id=ç»„ä»¶ID',
        'copy-error': 'æ— æ³•åŠ è½½ç»„ä»¶',
        'btn-copy': 'å¤åˆ¶',
        'copy-success': 'å·²å¤åˆ¶',
        'lang-label': 'English'
      },
      en: {
        'back': 'Back',
        'preview-title': 'Live Preview',
        'preview-desc': 'Adjust parameters on the right to see changes.',
        'loading-params': 'Loading component parameters...',
        'use-code': 'Usage Snippet',
        'no-component-title': 'Component not found',
        'no-component-desc': 'Please check if the component ID is correct.',
        'back-home': 'Back to Home',
        'load-fail-title': 'Failed to load',
        'load-fail-desc-prefix': 'Error: ',
        'no-config-title': 'Parameters',
        'no-config-desc': 'This component has no configurable parameters.',
        'need-id-title': 'Component ID required',
        'need-id-desc': 'Please append ?id=componentId in the URL.',
        'copy-error': 'Failed to load component',
        'btn-copy': 'Copy',
        'copy-success': 'Copied',
        'lang-label': 'ä¸­æ–‡'
      }
    };

    let currentLang = localStorage.getItem(LANG_KEY) || 'zh';

    function t(key) {
      return i18n[currentLang]?.[key] ?? i18n.zh[key] ?? key;
    }

    function getComponentName(component) {
      // ä¼˜å…ˆä½¿ç”¨ registry ä¸­çš„ nameEn å­—æ®µ
      if (currentLang === 'en' && component.nameEn) {
        return component.nameEn;
      }
      return component.name;
    }

    function getCategoryName(component) {
      // ä¼˜å…ˆä½¿ç”¨ registry ä¸­çš„ categoryNameEn å­—æ®µ
      if (currentLang === 'en' && component.categoryNameEn) {
        return component.categoryNameEn;
      }
      return component.categoryName || component.category;
    }

    function applyStaticTexts() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      const langBtn = document.getElementById('langToggle');
      if (langBtn) langBtn.textContent = t('lang-label');
    }

    async function loadComponent() {
      try {
        const res = await fetch('./registry/registry.json');
        const data = await res.json();
        const registry = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        component = registry.find(c => c.id === componentId);
        
        if (!component) {
          document.body.innerHTML = `
            <div style="padding: 4rem; text-align: center; color: var(--text-primary); background: var(--bg); min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
              <h2 style="margin-bottom: 0.5rem;">${t('no-component-title')}</h2>
              <p style="color: var(--text-secondary); margin-bottom: 1rem;">${t('no-component-desc')}</p>
              <a href="./index.html" style="display: inline-block; padding: 0.625rem 1.25rem; background: var(--primary); color: white; text-decoration: none; border-radius: 0.5rem;">${t('back-home')}</a>
            </div>
          `;
          return;
        }

        document.getElementById('componentName').textContent = getComponentName(component);
        document.getElementById('componentMeta').textContent = `${getCategoryName(component)} Â· v${component.version}`;
        
        if (component.props) {
          component.props.forEach(prop => {
            props[prop.key] = prop.default;
          });
        }

        renderControls();
        await updatePreview();
        updateCode();
      } catch (err) {
        console.error(err);
        document.body.innerHTML = `
          <div style="padding: 4rem; text-align: center; color: var(--text-primary); background: var(--bg); min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
            <h2 style="margin-bottom: 0.5rem;">${t('load-fail-title')}</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">${t('load-fail-desc-prefix')}${err.message}</p>
            <a href="./index.html" style="display: inline-block; padding: 0.625rem 1.25rem; background: var(--primary); color: white; text-decoration: none; border-radius: 0.5rem;">${t('back-home')}</a>
          </div>
        `;
      }
    }

    function renderControls() {
      const container = document.getElementById('controls');
      if (!component.props || component.props.length === 0) {
        container.innerHTML = `
          <div class="control-group">
            <h3>${t('no-config-title')}</h3>
            <p style="color: var(--text-secondary); font-size: 0.875rem; padding: 1rem; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
              ${t('no-config-desc')}
            </p>
          </div>
        `;
        return;
      }

      // æŒ‰åˆ†ç±»ç»„ç»‡å‚æ•°
      const groupedProps = {};
      component.props.forEach(prop => {
        const category = prop.category || 'é€šç”¨';
        if (!groupedProps[category]) {
          groupedProps[category] = [];
        }
        groupedProps[category].push(prop);
      });

      container.innerHTML = Object.entries(groupedProps).map(([category, categoryProps]) => {
        const propsHtml = categoryProps.map(prop => {
        const value = props[prop.key] ?? prop.default;
        let inputHtml = '';

        if (prop.type === 'color') {
          inputHtml = `<input type="color" value="${value}" onchange="updateProp('${prop.key}', this.value)">`;
        } else if (prop.type.startsWith('number')) {
          // æ™ºèƒ½è®¡ç®— step å€¼
          let step = prop.step;
          if (step == null) {
            // æ ¹æ®ç±»å‹å’ŒèŒƒå›´è‡ªåŠ¨åˆ¤æ–­
            if (prop.type.includes('(0-1)')) {
              // 0-1 èŒƒå›´çš„å‚æ•°ï¼Œä½¿ç”¨ 0.01 æ­¥è¿›
              step = 0.01;
            } else if (prop.type === 'number(px)' || prop.type === 'number(deg)') {
              // åƒç´ å’Œè§’åº¦ï¼Œä½¿ç”¨æ•´æ•°æ­¥è¿›
              step = 1;
            } else if (prop.min != null && prop.max != null) {
              const range = prop.max - prop.min;
              if (range <= 1) {
                // èŒƒå›´å¾ˆå°ï¼ˆå¦‚ 0-1ï¼‰ï¼Œä½¿ç”¨ 0.01
                step = 0.01;
              } else if (range <= 10) {
                // èŒƒå›´è¾ƒå°ï¼ˆå¦‚ 0.2-4ï¼‰ï¼Œä½¿ç”¨ 0.1
                step = 0.1;
              } else {
                // èŒƒå›´è¾ƒå¤§ï¼Œä½¿ç”¨ 1
                step = 1;
              }
            } else {
              // æ²¡æœ‰èŒƒå›´é™åˆ¶ï¼Œé»˜è®¤ä½¿ç”¨ 0.1
              step = 0.1;
            }
          }
          
          const hasRange = prop.min != null && prop.max != null;
          if (hasRange) {
            inputHtml = `
                <div class="range-input-group">
              <input type="range" min="${prop.min}" max="${prop.max}" step="${step}" value="${value}" 
                     oninput="updateProp('${prop.key}', parseFloat(this.value)); this.nextElementSibling.value = this.value">
                  <input type="number" min="${prop.min}" max="${prop.max}" step="${step}" value="${value}" 
                         onchange="updateProp('${prop.key}', parseFloat(this.value)); this.previousElementSibling.value = this.value">
                </div>
            `;
          } else {
            inputHtml = `<input type="number" step="${step}" value="${value}" onchange="updateProp('${prop.key}', parseFloat(this.value))">`;
          }
        } else if (prop.type === 'enum') {
            const options = (prop.enum || []).map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
          inputHtml = `<select onchange="updateProp('${prop.key}', this.value)">${options}</select>`;
        } else {
          inputHtml = `<input type="text" value="${value}" onchange="updateProp('${prop.key}', this.value)">`;
        }

        return `
          <div class="control-item">
            <label class="control-label">
              ${prop.key}
              ${prop.desc ? `<small>${prop.desc}</small>` : ''}
            </label>
            ${inputHtml}
            </div>
          `;
        }).join('');

        return `
          <div class="control-group">
            <h3>${category}</h3>
            ${propsHtml}
          </div>
        `;
      }).join('');
    }

    async function updateProp(key, value) {
      // ç¡®ä¿æ•°å­—ç±»å‹çš„å€¼è¢«æ­£ç¡®è½¬æ¢
      const propDef = component.props?.find(p => p.key === key);
      if (propDef && propDef.type.startsWith('number')) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          props[key] = numValue;
        } else {
          props[key] = value;
        }
      } else {
      props[key] = value;
      }
      await updatePreview();
      updateCode();
    }

    async function updatePreview() {
      const categoryPath = component.category.replace('/', '/');
      const componentPath = `./components/${categoryPath}/${component.id}.html`;
      const frame = document.getElementById('previewFrame');
      
      const cssVars = {};
      if (component.cssVars) {
        Object.keys(props).forEach(key => {
          const cssVar = component.cssVars[key];
          if (cssVar) {
            let val = props[key];
            if (component.props) {
              const propDef = component.props.find(p => p.key === key);
              if (propDef) {
                if (propDef.type === 'number(px)') {
                val = val + 'px';
                } else if (propDef.type === 'number(deg)') {
                val = val + 'deg';
                } else if (propDef.type === 'string' && typeof val === 'string') {
                  // å¯¹äºå­—ç¬¦ä¸²ç±»å‹çš„ CSS å˜é‡ï¼Œéœ€è¦åŠ å¼•å·
                  val = `"${val.replace(/"/g, '\\"')}"`;
                }
              }
            }
            cssVars[cssVar] = val;
          }
        });
      }

      const styleStr = Object.entries(cssVars).map(([k, v]) => `${k}: ${v}`).join('; ');
      
      // æ„å»º data-propsï¼ˆåŒ…å«æ‰€æœ‰ propsï¼Œç”¨äºéœ€è¦ JavaScript å¤„ç†çš„ç»„ä»¶ï¼‰
      const dataProps = {};
      Object.keys(props).forEach(key => {
        const val = props[key];
        // ç¡®ä¿å€¼è¢«æ­£ç¡®åºåˆ—åŒ–
        if (typeof val === 'string') {
          dataProps[key] = val;
        } else if (typeof val === 'number') {
          dataProps[key] = val;
        } else if (typeof val === 'boolean') {
          dataProps[key] = val;
        } else {
          dataProps[key] = String(val);
        }
      });
      const dataPropsStr = JSON.stringify(dataProps).replace(/"/g, '&quot;');
      
      const componentHtml = await getComponentHTML(componentPath);
      
      // å¦‚æœç»„ä»¶ HTML ä¸­åŒ…å« data-cmp-idï¼Œéœ€è¦æ·»åŠ /æ›´æ–° data-props å’Œ data-label å±æ€§
      let finalComponentHtml = componentHtml;
      // æŸ¥æ‰¾åŒ…å« data-cmp-id çš„ div æ ‡ç­¾
      const cmpIdPattern = /<div([^>]*data-cmp-id="[^"]*"[^>]*)>/;
      const match = componentHtml.match(cmpIdPattern);
      if (match) {
        let newAttrs = match[1];
        
        // å¤„ç† data-labelï¼ˆå¦‚æœ props ä¸­æœ‰ labelï¼Œä¼˜å…ˆä½¿ç”¨å®ƒï¼‰
        if (props.label !== undefined) {
          const labelValue = String(props.label).replace(/"/g, '&quot;');
          // ç§»é™¤æˆ–æ›¿æ¢ç°æœ‰çš„ data-label
          newAttrs = newAttrs.replace(/data-label="[^"]*"/, '');
          newAttrs += ` data-label="${labelValue}"`;
        }
        
        // å¤„ç† data-props
        if (newAttrs.indexOf('data-props=') === -1) {
          // æ·»åŠ  data-props å±æ€§
          newAttrs += ` data-props="${dataPropsStr}"`;
        } else {
          // æ›¿æ¢ç°æœ‰çš„ data-props
          newAttrs = newAttrs.replace(/data-props="[^"]*"/, `data-props="${dataPropsStr}"`);
        }
        
        // æ›¿æ¢æ•´ä¸ª div æ ‡ç­¾
        finalComponentHtml = componentHtml.replace(
          cmpIdPattern,
          `<div${newAttrs}>`
        );
      }
      
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <style>
            body {
              margin: 0;
              padding: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              background: transparent;
            }
          </style>
        </head>
        <body>
          <div style="${styleStr}">
            ${finalComponentHtml}
          </div>
        </body>
        </html>
      `;

      frame.srcdoc = html;
    }

    async function getComponentHTML(path) {
      try {
        const res = await fetch(path);
        let text = await res.text();
        
        // ç§»é™¤ @cmp-manifest æ³¨é‡Šå—
        text = text.replace(/<!--\s*@cmp-manifest[\s\S]*?-->/g, '').trim();
        
        // å¦‚æœåŒ…å«å®Œæ•´çš„ HTML æ–‡æ¡£ç»“æ„ï¼Œæå– body å†…å®¹
        if (text) {
          const bodyRegex = new RegExp('<body[^>]*>([\\s\\S]*)</' + 'body>', 'i');
          const bodyMatch = text.match(bodyRegex);
          if (bodyMatch && bodyMatch[1]) {
            text = bodyMatch[1].trim();
          }
        }
        
        // ç¡®ä¿è¿”å›çš„ä»£ç æœ‰é€‚å½“çš„ç¼©è¿›
        const lines = text.split('\n');
        const indented = lines.map((line, index) => {
          // ç¬¬ä¸€è¡Œä¸ç¼©è¿›ï¼Œå…¶ä»–è¡Œç¼©è¿› 2 ä¸ªç©ºæ ¼
          if (index === 0) return line.trim();
          return '  ' + line;
        }).join('\n');
        
        return indented;
      } catch (err) {
        console.error('Failed to load component HTML:', err);
        return '  <!-- ç»„ä»¶å†…å®¹ -->';
      }
    }

    let currentCode = ''; // å­˜å‚¨å½“å‰ä»£ç ï¼Œç”¨äºå¤åˆ¶

    async function updateCode() {
      if (!component) return;
      
      const categoryPath = component.category.replace('/', '/');
      const componentPath = `./components/${categoryPath}/${component.id}.html`;
      
      // è·å–ç»„ä»¶çš„å®é™… HTML å†…å®¹
      const componentHtml = await getComponentHTML(componentPath);
      
      // æ„å»º CSS å˜é‡ï¼ˆä½¿ç”¨å½“å‰ props å€¼ï¼‰
      const cssVars = {};
      if (component.cssVars) {
        Object.keys(props).forEach(key => {
          const cssVar = component.cssVars[key];
          if (cssVar) {
            let val = props[key];
            const propDef = component.props.find(p => p.key === key);
            if (propDef && propDef.type === 'number(px)') {
              val = val + 'px';
            } else if (propDef && propDef.type === 'number(deg)') {
              val = val + 'deg';
            }
            cssVars[cssVar] = val;
          }
        });
      }

      // ç”Ÿæˆ style å­—ç¬¦ä¸²
      const styleStr = Object.entries(cssVars)
        .map(([k, v]) => `${k}: ${v}`)
        .join('; ');
      
      // ç”Ÿæˆå®Œæ•´çš„ç»„ä»¶ä»£ç 
      if (styleStr) {
        currentCode = `<div class="cmp" data-cmp-id="${component.id}" style="${styleStr}">
${componentHtml}
</div>`;
      } else {
        currentCode = `<div class="cmp" data-cmp-id="${component.id}">
${componentHtml}
</div>`;
      }

      document.getElementById('codeOutput').textContent = currentCode;
    }
    
    async function copyCode() {
      if (!currentCode) {
        await updateCode();
      }
      
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(currentCode);
          // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸º"å·²å¤åˆ¶"
          const btn = document.getElementById('codeCopyBtn');
          const originalText = btn.querySelector('span').textContent;
          btn.querySelector('span').textContent = t('copy-success');
          setTimeout(() => {
            btn.querySelector('span').textContent = originalText;
          }, 2000);
        } else {
          fallbackCopyCode(currentCode);
        }
      } catch (err) {
        console.error('Failed to copy code:', err);
        fallbackCopyCode(currentCode);
      }
    }
    
    function fallbackCopyCode(code) {
      const textarea = document.createElement('textarea');
      textarea.value = code;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      const btn = document.getElementById('codeCopyBtn');
      const originalText = btn.querySelector('span').textContent;
      btn.querySelector('span').textContent = t('copy-success');
      setTimeout(() => {
        btn.querySelector('span').textContent = originalText;
      }, 2000);
    }
    
    window.copyCode = copyCode;

    window.updateProp = updateProp;

    if (componentId) {
      loadComponent();
    } else {
      document.body.innerHTML = `
        <div style="padding: 4rem; text-align: center; color: var(--text-primary); background: var(--bg); min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”</div>
          <h2 style="margin-bottom: 0.5rem;">${t('need-id-title')}</h2>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">${t('need-id-desc')}</p>
          <a href="./index.html" style="display: inline-block; padding: 0.625rem 1.25rem; background: var(--primary); color: white; text-decoration: none; border-radius: 0.5rem;">${t('back-home')}</a>
        </div>
      `;
    }

    function switchLang() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem(LANG_KEY, currentLang);
      // åªåˆ·æ–°é™æ€ UI æ–‡æœ¬ï¼›åŠ¨æ€å†…å®¹ï¼ˆç»„ä»¶åç§°ç­‰ï¼‰æ¥è‡ª manifestï¼Œæœ¬èº«æ˜¯è¯­è¨€æ— å…³çš„
      if (component) {
        // æ›´æ–°ç»„ä»¶åç§°å’Œåˆ†ç±»æ˜¾ç¤º
        document.getElementById('componentName').textContent = getComponentName(component);
        document.getElementById('componentMeta').textContent = `${getCategoryName(component)} Â· v${component.version}`;
        // é‡æ–°æ¸²æŸ“å³ä¾§æ–‡æ¡ˆå’Œç©ºçŠ¶æ€ç­‰
        renderControls();
        updateCode();
      }
      // é¡¶éƒ¨ã€é¢„è§ˆåŒºç­‰é™æ€æ–‡æœ¬
      document.body.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      const langBtn = document.getElementById('langToggle');
      if (langBtn) langBtn.textContent = t('lang-label');
    }

    const langToggle = document.getElementById('langToggle');
    if (langToggle) {
      langToggle.addEventListener('click', switchLang);
    }

    applyStaticTexts();
  </script>
</body>
</html>
